<!--Programmer: Chris Tralie!-->
<!--Purpose: Front end point chooser / debugger for line segment intersection function!-->
<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src = "GeomPrimitives copy.js"></script>
</head>
<!-- This is how you include external scripts in Javascript !-->
<body>
<h name = "Asteroids"> Asteroids</h>
<table>
  <tr>
    <td width = "100">
      <button type = "button" onclick = "restart()">Restart</button>
    </td>
  </tr>
  <tr>
    <td> Score: <a id="Score"></a></td>
  </tr>
</table>

<canvas id = "segcanvas" width = "700" height = "500" style="border:1px solid #777777;">

<script>

var canvas = document.getElementById("segcanvas"),
ctx = canvas.getContext("2d");

var x = 250,  //initial x
    y = 250,  // initial y
    velY = 0,
    velX = 0,
    speed = 1, // max speed
    friction = 0.98, // friction
    score = 0;
    keys = [],
    shots = [],
    asteroids = [],
    interval = 2000;


function update() {
    // check the keys and do the movement.
    if (keys[38]) {
        if (velY > -speed) {
            velY--;
        }
    }
    if (keys[40]) {
        if (velY < speed) {
            velY++;
        }
    }
    if (keys[39]) {
        if (velX < speed) {
            velX++;
        }
    }
    if (keys[37]) {
        if (velX > -speed) {
            velX--;
        }
    }
    if (keys[88]) { // gun shot
      keys[88] = false;
    }

    // apply some friction to y velocity.
    velY *= friction;
    y += velY;

    // apply some friction to x velocity.
    velX *= friction;
    x += velX;

    // bounds checking
    if (x >= canvas.width - 5) {
        x = canvas.width - 5;
    } else if (x <= 5) {
        x = 5;
    }

    if (y > canvas.height) {
        y = canvas.height;
    } else if (y <= 5) {
        y = 5;
    }

    // do the drawing
    repaint();

    setTimeout(update, 10);

}
function asteroid() {
  var coordinates = getRandomCoordinates();
  var velocity = getRandomVelocity();
  var size = Math.ceil(Math.random() * (3));
  velocity.push(size);
  asteroids.push(coordinates.concat(velocity));
}
function repaint() {
  repaintShip();
  repaintShots();
  repaintAsteroids();
}
/*function repaintShip(){
  checkShipCollision();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();

  ctx.arc(x, y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
}*/
function repaintShip(){
  checkShipCollision();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.moveTo(x-4,y-4);
  ctx.lineTo(x,y+2);
  ctx.lineTo(x+4,y-4);
  ctx.closePath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'White';
  ctx.stroke();
  //ctx.arc(x, y, 5, 0, Math.PI * 2);
  //ctx.fillStyle = "#ffffff";
  //ctx.fill();
}
function repaintShots(){
  for (l=0;l<shots.length;l++){
    // adjust coordinates
    shots[l][1] += shots[l][3];
    shots[l][0] += shots[l][2];
    //delete it if its out of the page
    var Cx = shots[l][0];
    var Cy = shots[l][1];
    if(Cx > canvas.width || Cx < 0 || Cy > canvas.height || Cy < 0){
      shots.splice(l,1);
    }
    else {
      ctx.beginPath();
      ctx.arc(shots[l][0],shots[l][1], 2, 0, Math.PI * 2);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      checkAsteroidCollision(shots[l],l);
    }
  }
}
function repaintAsteroids(){
  for (i=0;i<asteroids.length;i++){
    // adjust coordinates
    asteroids[i][1] += asteroids[i][3];
    asteroids[i][0] += asteroids[i][2];
    //delete it if its out of the page
    var Cx = asteroids[i][0];
    var Cy = asteroids[i][1];
    if(Cx > canvas.width || Cx < 0 || Cy > canvas.height || Cy < 0){
      asteroids.splice(i,1);
    }
    else{
      var scale = asteroids[i][4];
      ctx.beginPath();
      ctx.moveTo(asteroids[i][0]+10*scale, asteroids[i][1]+10*scale);
      ctx.lineTo(asteroids[i][0]+8*scale, asteroids[i][1]+5*scale);
      ctx.lineTo(asteroids[i][0]+10*scale, asteroids[i][1]-10*scale);
      ctx.lineTo(asteroids[i][0], asteroids[i][1]-5*scale);
      ctx.lineTo(asteroids[i][0]-10*scale, asteroids[i][1]-10*scale);
      ctx.lineTo(asteroids[i][0]-3*scale, asteroids[i][1]+2*scale);
      ctx.lineTo(asteroids[i][0]-10*scale, asteroids[i][1]+10*scale);
      ctx.closePath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'White';
      ctx.stroke();

    }
  }
}

function checkAsteroidCollision(shot,index){
  for (j=0; j < asteroids.length; j++){
    var scale = asteroids[j][4];
    var sht = [shot[0],shot[1]];
    var pts = [[asteroids[j][0]+10*scale, asteroids[j][1]+10*scale],[asteroids[j][0]+8*scale, asteroids[j][1]+5*scale],[asteroids[j][0]+10*scale, asteroids[j][1]-10*scale],[asteroids[j][0], asteroids[j][1]-5*scale],[asteroids[j][0]-10*scale, asteroids[j][1]-10*scale],[asteroids[j][0]-3*scale, asteroids[j][1]+2*scale],[asteroids[j][0]-10*scale, asteroids[j][1]+10*scale]];
    // Tests if point is within the astroid polygon
    if (point_in_polygon(pts, sht)) { // Impact
        shots.splice(index,1);
        if(scale > 1){
          var nVelocities = [getRandomVelocity(),getRandomVelocity()];
          asteroids[j][4]--;
          asteroids[j][2] = nVelocities[0][0];
          asteroids[j][3] = nVelocities[0][1];;
          var ast = [asteroids[j][0],asteroids[j][1],nVelocities[1][0],nVelocities[1][1],asteroids[j][4]];
          asteroids.push(ast);
        }
        else{
          asteroids.splice(j,1);
        }
        score++;
        document.getElementById('Score').innerHTML = "" + score;
    }
  }
}

function checkShipCollision(){
  for (k=0; k < asteroids.length; k++){
    //check if distance from circle center to point in  is < radius
    var scale = asteroids[k][4];
    var pt = [x,y]
    var points = [[asteroids[k][0]+10*scale, asteroids[k][1]+10*scale],[asteroids[k][0]+8*scale, asteroids[k][1]+5*scale],[asteroids[k][0]+10*scale, asteroids[k][1]-10*scale],[asteroids[k][0], asteroids[k][1]-5*scale],[asteroids[k][0]-10*scale, asteroids[k][1]-10*scale],[asteroids[k][0]-3*scale, asteroids[k][1]+2*scale],[asteroids[k][0]-10*scale, asteroids[k][1]+10*scale]];
    if (point_in_polygon(points, pt)){// Impact
      if (confirm('You Lost :( !! Wanna play Again?')) {
        location.reload();
      }
      else {}
    }
  }
}
function getRandomCoordinates() {
  return [Math.floor(Math.random() * (canvas.height - 1)),Math.floor(Math.random() * (canvas.height - 1))];
}
function getRandomVelocity() {
  var plusOrMinusX = Math.random() < 0.5 ? -1 : 1;
  var plusOrMinusY = Math.random() < 0.5 ? -1 : 1;
  return [plusOrMinusX*Math.random(),plusOrMinusY*Math.random()];
}
function restart() {
  location.reload();
}
update();

//Astroid creator
setInterval(function(){
    asteroid();
}, interval);

setInterval(function(){
  if ( interval > 1000){
    interval = interval - 50;
  }
}, 10000);

// Disable page scrolling
window.addEventListener("keydown", function(e) {
    // space and arrow keys
    if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
        e.preventDefault();
    }
}, false);

//Shooting and Movement events
document.body.addEventListener("keydown", function (e) {
    keys[e.keyCode] = true;

    //shots
    if (e.keyCode == 88){
      if(Math.abs(velX) > Math.abs(velY)){
        var vX = 2;
        var vY = Math.abs(velY/velX) * 2;
      } else {
        var vY = 2;
        var vX = Math.abs(velX/velY) * 2;
      }
      var multX = 1;
      var multY = 1;
      if (velX < 0){
        multX = -1;
      }
      if (velY < 0){
        multY = -1;
      }
      shots.push([x,y,vX*multX,vY*multY]);
    }
});
document.body.addEventListener("keyup", function (e) {
    keys[e.keyCode] = false;
  });
document.body.addEventListener("shot", function (e) {
    keys[e.keyCode] = false;
  });
</script>


</body>
</html>
